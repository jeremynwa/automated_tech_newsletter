<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tech Digest</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter",
          sans-serif;
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        min-height: 100vh;
        padding: 2rem;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 2rem;
        animation: fadeInDown 0.8s ease;
      }

      h1 {
        color: white;
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
      }

      .subtitle {
        color: rgba(255, 255, 255, 0.95);
        font-size: 1.15rem;
        font-weight: 400;
        margin-bottom: 0;
      }

      .filter-bar {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 1.5rem 2rem;
        margin: 2rem auto 3rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        animation: fadeInUp 0.8s ease 0.3s both;
      }

      .filter-section {
        margin-bottom: 1.25rem;
      }

      .filter-section:last-child {
        margin-bottom: 0;
      }

      .filter-label {
        color: #1e293b;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
      }

      .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .filter-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        background: white;
        color: #475569;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .filter-btn:hover {
        border-color: #06b6d4;
        color: #06b6d4;
        transform: translateY(-1px);
      }

      .filter-btn.active {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        border-color: #06b6d4;
        color: white;
      }

      .custom-date-input,
      .search-input {
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        background: white;
        color: #475569;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s ease;
        flex: 1;
        min-width: 200px;
      }

      .custom-date-input:focus,
      .search-input:focus {
        outline: none;
        border-color: #06b6d4;
      }

      .search-button {
        width: 100%;
        padding: 0.9rem;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        margin-top: 1.25rem;
      }

      .search-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
      }

      .search-button:active {
        transform: translateY(0);
      }

      .feed {
        animation: fadeInUp 0.8s ease 0.4s both;
      }

      .day-separator {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1.25rem 2rem;
        border-radius: 50px;
        margin: 3rem auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        text-align: center;
        max-width: 400px;
      }

      .day-separator:first-child {
        margin-top: 0;
      }

      .date-text {
        color: #0891b2;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .day-content {
        display: grid;
        gap: 2.5rem;
        margin-bottom: 2rem;
      }

      /* Enhanced section styling with hover effects */
      .section {
        background: white;
        padding: 25px;
        margin-bottom: 25px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .section:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      }

      .section h2 {
        color: #0891b2;
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 3px solid #0891b2;
        padding-bottom: 10px;
        font-size: 1.75rem;
      }

      /* Enhanced article styling with hover effects */
      .article {
        margin-bottom: 25px;
        padding: 20px;
        padding-left: 24px;
        border-bottom: 1px solid #eee;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
      }

      /* Left bar that appears on hover */
      .article::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #06b6d4 0%, #0891b2 100%);
        transform: scaleY(0);
        transition: transform 0.3s ease;
        transform-origin: top;
      }

      .article:hover {
        transform: translateX(8px);
        border-color: #06b6d4;
        background: linear-gradient(135deg, #ecfeff 0%, #ffffff 100%);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
      }

      .article:hover::before {
        transform: scaleY(1);
      }

      .article:last-child {
        border-bottom: none;
      }

      .article-title {
        font-size: 1.3em;
        font-weight: 700;
        margin-bottom: 8px;
        color: #0891b2;
        transition: color 0.2s ease;
      }

      .article-title a {
        color: inherit;
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .article:hover .article-title,
      .article:hover .article-title a {
        color: #06b6d4;
      }

      .article-meta {
        color: #64748b;
        font-size: 0.9em;
        margin-bottom: 10px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .article-summary {
        line-height: 1.7;
        color: #475569;
        margin-bottom: 15px;
      }

      .article-summary strong {
        display: block;
        margin-top: 12px;
        margin-bottom: 8px;
        color: #1e293b;
        font-size: 1.05em;
      }

      .article-summary ul {
        margin: 10px 0;
        padding-left: 20px;
        list-style-type: disc;
      }

      .article-summary li {
        margin-bottom: 8px;
        line-height: 1.6;
        color: #475569;
      }

      .article-summary p {
        margin-bottom: 10px;
      }

      .authors {
        color: #64748b;
        font-size: 0.9em;
        margin-top: 8px;
        margin-bottom: 8px;
      }

      .links {
        margin-top: 12px;
        display: flex;
        gap: 12px;
      }

      .links a {
        display: inline-block;
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        padding: 8px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
      }

      .links a:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
      }

      .no-results {
        text-align: center;
        padding: 3rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        margin-top: 2rem;
      }

      .no-results h2 {
        color: #1e293b;
        margin-bottom: 1rem;
      }

      .no-results p {
        color: #64748b;
      }

      .hidden {
        display: none !important;
      }

      .article.keyword-match {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-color: #f59e0b;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
      }

      .article.keyword-match::before {
        background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
      }

      .article.keyword-match:hover {
        border-color: #d97706;
        box-shadow: 0 6px 16px rgba(245, 158, 11, 0.3);
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        h1 {
          font-size: 2rem;
        }

        .subtitle {
          font-size: 1rem;
        }

        .section {
          padding: 1.5rem;
        }

        .article {
          padding: 1rem;
        }

        .links {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Tech Digest</h1>
        <p class="subtitle">
          Daily AI, Tech News, Research & Hacker News Summaries
        </p>
      </header>

      <div class="filter-bar">
        <div class="filter-section">
          <label class="filter-label">Search Keywords</label>
          <div class="filter-options">
            <input
              type="text"
              class="search-input"
              placeholder="Search articles by keyword..."
              id="keyword-search"
            />
          </div>
        </div>

        <div class="filter-section">
          <label class="filter-label">Time Range</label>
          <div class="filter-options">
            <button class="filter-btn active" data-range="all">All</button>
            <button class="filter-btn" data-range="today">Today</button>
            <button class="filter-btn" data-range="3days">Last 3 Days</button>
            <button class="filter-btn" data-range="week">Last Week</button>
            <button class="filter-btn" data-range="month">Last Month</button>
            <input
              type="date"
              class="custom-date-input"
              placeholder="Custom Date"
              id="custom-date"
            />
          </div>
        </div>

        <div class="filter-section">
          <label class="filter-label">Content Type</label>
          <div class="filter-options">
            <button class="filter-btn active" data-type="tech">
              World Tech News
            </button>
            <button class="filter-btn active" data-type="hn">
              Hacker News
            </button>
            <button class="filter-btn active" data-type="research">
              Research Papers
            </button>
          </div>
        </div>

        <button class="search-button" id="apply-filters">Apply Filters</button>
      </div>

      <div class="feed" id="feed">
        {% for digest in digests %}
        <div class="digest-day" data-date="{{ digest.date }}">
          <div class="day-separator">
            <div class="date-text">{{ digest.formatted_date }}</div>
          </div>

          <div class="day-content">{{ digest.content|safe }}</div>
        </div>
        {% endfor %}
      </div>

      <div class="no-results hidden" id="no-results">
        <h2>No Results Found</h2>
        <p>Try adjusting your filters or search terms</p>
      </div>
    </div>

    <script>
      // TODAY'S DATE - FIXED
      const TODAY = new Date();
      TODAY.setHours(0, 0, 0, 0);
      console.log("Today is:", TODAY.toDateString());

      // Get all digest dates for filtering
      const allDigests = document.querySelectorAll(".digest-day");
      const digestDates = Array.from(allDigests).map((d) => {
        const dateStr = d.dataset.date;
        const date = new Date(dateStr + "T00:00:00"); // Force local timezone
        console.log("Digest date:", dateStr, "â†’", date.toDateString());
        return {
          element: d,
          date: date,
          dateStr: dateStr,
        };
      });

      // Filter state
      let activeFilters = {
        range: "all",
        types: ["tech", "hn", "research"],
        keyword: "",
        customDate: null,
      };

      // UI Elements
      const rangeButtons = document.querySelectorAll("[data-range]");
      const typeButtons = document.querySelectorAll("[data-type]");
      const applyButton = document.getElementById("apply-filters");
      const keywordInput = document.getElementById("keyword-search");
      const customDateInput = document.getElementById("custom-date");
      const noResults = document.getElementById("no-results");

      // Handle range filter buttons
      rangeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          rangeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          activeFilters.range = btn.dataset.range;
          customDateInput.value = "";
          activeFilters.customDate = null;
        });
      });

      // Handle custom date input
      customDateInput.addEventListener("change", () => {
        rangeButtons.forEach((b) => b.classList.remove("active"));
        activeFilters.range = "custom";
        activeFilters.customDate = new Date(
          customDateInput.value + "T00:00:00"
        );
        console.log(
          "Custom date selected:",
          activeFilters.customDate.toDateString()
        );
      });

      // Handle type filter buttons (multiple selection)
      typeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          btn.classList.toggle("active");
          const type = btn.dataset.type;
          if (activeFilters.types.includes(type)) {
            activeFilters.types = activeFilters.types.filter((t) => t !== type);
          } else {
            activeFilters.types.push(type);
          }
        });
      });

      // Handle keyword input
      keywordInput.addEventListener("input", () => {
        activeFilters.keyword = keywordInput.value.toLowerCase().trim();
      });

      // Apply filters
      applyButton.addEventListener("click", applyFilters);

      // Also apply on Enter key in search
      keywordInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          applyFilters();
        }
      });

      function applyFilters() {
        let visibleCount = 0;

        digestDates.forEach(({ element, date, dateStr }) => {
          let showDigest = false;

          // Date range filter
          if (activeFilters.range === "all") {
            showDigest = true;
          } else if (
            activeFilters.range === "custom" &&
            activeFilters.customDate
          ) {
            showDigest = date.getTime() === activeFilters.customDate.getTime();
            console.log(
              "Custom filter:",
              dateStr,
              date.getTime() === activeFilters.customDate.getTime()
            );
          } else if (activeFilters.range === "today") {
            showDigest = date.getTime() === TODAY.getTime();
            console.log(
              "Today filter:",
              dateStr,
              date.getTime() === TODAY.getTime()
            );
          } else if (activeFilters.range === "3days") {
            const threeDaysAgo = new Date(TODAY);
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            showDigest = date >= threeDaysAgo;
            console.log("3 days filter:", dateStr, date >= threeDaysAgo);
          } else if (activeFilters.range === "week") {
            const weekAgo = new Date(TODAY);
            weekAgo.setDate(weekAgo.getDate() - 7);
            showDigest = date >= weekAgo;
          } else if (activeFilters.range === "month") {
            const monthAgo = new Date(TODAY);
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            showDigest = date >= monthAgo;
          }

          if (!showDigest) {
            element.classList.add("hidden");
            return;
          }

          // Content type filter + Keyword filter at ARTICLE level
          const sections = element.querySelectorAll(".section");
          let hasVisibleContent = false;

          sections.forEach((section) => {
            const sectionHeader = section.querySelector("h2");
            if (!sectionHeader) return;

            const headerText = sectionHeader.textContent.toLowerCase();
            let sectionType = "";

            if (
              headerText.includes("world tech") ||
              headerText.includes("tech news")
            ) {
              sectionType = "tech";
            } else if (headerText.includes("hacker news")) {
              sectionType = "hn";
            } else if (headerText.includes("research")) {
              sectionType = "research";
            }

            // Check if this section type is selected
            const isTypeSelected = activeFilters.types.includes(sectionType);

            if (!isTypeSelected) {
              section.style.display = "none";
              return;
            }

            // If keyword search is active, filter individual articles
            if (activeFilters.keyword) {
              const articles = section.querySelectorAll(".article");
              let visibleArticles = 0;

              articles.forEach((article) => {
                const articleText = article.textContent.toLowerCase();
                if (articleText.includes(activeFilters.keyword)) {
                  article.classList.remove("hidden");
                  article.classList.add("keyword-match"); // Highlight matching articles
                  visibleArticles++;
                } else {
                  article.classList.add("hidden");
                  article.classList.remove("keyword-match");
                }
              });

              if (visibleArticles > 0) {
                section.style.display = "block";
                hasVisibleContent = true;
              } else {
                section.style.display = "none";
              }
            } else {
              // No keyword search - show all articles in this section
              const articles = section.querySelectorAll(".article");
              articles.forEach((article) => {
                article.classList.remove("hidden");
                article.classList.remove("keyword-match");
              });
              section.style.display = "block";
              hasVisibleContent = true;
            }
          });

          if (hasVisibleContent) {
            element.classList.remove("hidden");
            visibleCount++;
          } else {
            element.classList.add("hidden");
          }
        });

        // Show/hide no results message
        if (visibleCount === 0) {
          noResults.classList.remove("hidden");
        } else {
          noResults.classList.add("hidden");
        }

        console.log("Filter applied. Visible digests:", visibleCount);
      }

      // Initial load - show everything
      applyFilters();
    </script>
  </body>
</html>
